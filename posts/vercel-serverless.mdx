---
title: vercel serverless function, cache
date: 2023-11-09
category: ìŠ¤í„°ë””
---

## Vercel Serverless Function

- íë¦„

![Untitled 0](https://github.com/icecokel/VSCoke/assets/55083854/7f143d4d-d681-48c5-9448-c828aacbca93)

<aside>ğŸ’¡ [Serverless function](https://vercel.com/docs/functions/serverless-functions)</aside>

- page router
  `/api/*`
  `getServerSideProps`
- app router

  ```jsx
  import { cache } from "react";

  export const revalidate = 3600; // revalidate the data at most every hour

  export const getItem = cache(async (id: string) => {
    const item = await db.item.findUnique({ id });
    return item;
  });
  ```

next js â†’ be api

## ColdStart

### ê°œë…

FaaS(Function-as-a-Service)

1. ì¸í”„ë¼ í”„ë¡œë¹„ì €ë‹
2. ëŸ°íƒ€ì„ í™˜ê²½ ì¡°ì„±
3. ì–´í”Œë¦¬ì¼€ì´ì…˜ ë¶€ìŠ¤íŠ¸íŠ¸ë© ( ì»´íŒŒì¼, ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¸ìŠ¤í†¨ ë“±ë“±)

- FaaSëŠ”ì‹¤í–‰ë˜ëŠ” ë™ì•ˆë§Œ ê´€ë ¨ëœ ìì›ì´ í• ë‹¹

ì˜¤ëœ ê¸°ê°„ í˜¸ì¶œë˜ì§€ ì•ŠëŠ” í•¨ìˆ˜ì˜ ìì›ì´ íšŒìˆ˜ ëœ ìƒíƒœì—ì„œ í•¨ìˆ˜ê°€ ì¬ í˜¸ì¶œ ë˜ì—ˆì„ ë•Œ, ê¸°ì¡´ì— ê±¸ë¦¬ë˜ ì‹œê°„ë³´ë‹¤ ì˜¤ë˜ ê±¸ë¦¬ëŠ” ìƒí™©

### í•´ê²° ë°©ë²•

1. ISR
2. ë°ì´í„° ìºì‹±
3. ë°ì´í„° ì†ŒìŠ¤ì™€ ê°€ê¹Œìš´ ë¦¬ì „ì„ ì„ íƒ
4. í•¨ìˆ˜ë‚´ì˜ ì™¸ë¶€ ì¢…ì†ì„±ì„ ì •ë¦¬
5. warm start ìœ ì§€

## Cache

- [ì°¸ê³ ](https://nextjs.org/docs/app/building-your-application/data-fetching/fetching-caching-and-revalidating)

- ìš©ë„Â `GET`ë‚˜`HEAD`ë°©ë²•ì„ ìš”ì²­í•©ë‹ˆë‹¤.
- ìš”ì²­ì— í—¤ë”ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤Â `Range`
- ìš”ì²­ì— í—¤ë”ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤Â `Authorization`
- ì‘ë‹µì€`200` `404` `301` `302` `307` `308`ìƒíƒœ ì½”ë“œë¥¼Â ì‚¬ìš©í•©ë‹ˆë‹¤.
- `10MB`ë¥¼ì‘ë‹µì€ ë‚´ìš© ê¸¸ì´ë¥¼Â ì´ˆê³¼í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ .
- ì‘ë‹µì— í—¤ë”ê°€ í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤Â `set-cookie`
- ì‘ë‹µì˜ í—¤ë” ì—Â `privateno-cacheno-storeCache-Control`ë˜ëŠ” ì§€ì‹œì–´ê°€Â í¬í•¨ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤Â .

### **x-vercel-cache**

- [ì°¸ê³ ](https://vercel.com/docs/edge-network/headers#x-vercel-cache)

**MISS** : edge-network-cacheì—ì„œ ì°¾ì§€ ëª»í•˜ê³  origin serverì—ì„œ ì‘ë‹µì´ ì œê³µ

![Untitled 1](https://github.com/icecokel/VSCoke/assets/55083854/7cc04942-f1a5-4ef4-970d-545218124591)

**HIT** : edge-network-cacheì—ì„œ ì‘ë‹µì´ ì œê³µ

![Untitled 2](https://github.com/icecokel/VSCoke/assets/55083854/4074ad20-abb2-4a2f-beb9-8abfc0ab4bf1)

**STALE** : edge-network-cacheì—ì„œ ì‘ë‹µì´ ì œê³µ, edge-cacheì— ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸

![Untitled 3](https://github.com/icecokel/VSCoke/assets/55083854/ede1cf29-1e5c-4ec8-98db-5556a8c4ccf4)

**PRERENDER** : ì •ì  ì €ì¥ì†Œì—ì„œ ì‘ë‹µì´ ì œê³µ

![Untitled 4](https://github.com/icecokel/VSCoke/assets/55083854/7b7c3d09-50a1-4e8a-a8fc-0f86e19a2623)

**REVIALIDATED** : origin-serverì—ì„œ ì‘ë‹µì´ ì œê³µë˜ì—ˆìœ¼ë©° ìˆ˜ì‹  ìš”ì²­ì—ì„œ ì‚¬ìš©ìì˜ ì¸ì¦ìœ¼ë¡œÂ ì¸í•´ ìºì‹œê°€ ìƒˆë¡œ ê³ ì³ì¡ŒìŠµë‹ˆë‹¤Â .

![Untitled 5](https://github.com/icecokel/VSCoke/assets/55083854/155507fc-635e-4e6e-ac27-980426109ea8)

**BYPASS** : ìºì‹œê°€ ìš°íšŒë˜ì–´ origin-severì—ì„œ ì‘ë‹µì´ ì œê³µë˜ì—ˆìŠµë‹ˆë‹¤.

![Untitled 6](https://github.com/icecokel/VSCoke/assets/55083854/2eec0327-21a0-4a01-aecc-5b2c5d6344bf)

> ì˜ˆì‹œëŠ” page routerë¡œ ì‘ì„± ë˜ì—ˆìŠµë‹ˆë‹¤.

```jsx
export async function getServerSideProps({ req, res }) {
  res.setHeader("Cache-Control", "public, s-maxage=10, stale-while-revalidate=59");

  return {
    props: {},
  };
}
```

- **maxage**
  ì´ ì§€ì‹œì–´ëŠ” Edge Networkì—ì„œ ì‘ë‹µì´ "ì‹ ì„ í•œ" ê²ƒìœ¼ë¡œ ê°„ì£¼ë˜ëŠ” ì‹œê°„(ì´ˆ)ì„ ì„¤ì •í•©ë‹ˆë‹¤.Â ì´ ê¸°ê°„ì´ ëë‚˜ë©´ Vercelì˜ Edge NetworkëŠ” ì„œë²„ë¦¬ìŠ¤ ê¸°ëŠ¥ì— ëŒ€í•œ "ìƒˆ" ì‘ë‹µìœ¼ë¡œ ì‘ë‹µì´ ë¹„ë™ê¸°ì‹ìœ¼ë¡œ ì¬ê²€ì¦ë  ë•Œê¹Œì§€ ì—ì§€ì—ì„œ "ì˜¤ë˜ëœ" ì‘ë‹µì„ ì œê³µí•©ë‹ˆë‹¤.
- **stale-while-revalidate**
  ì´Â `cache-control`ì§€ì‹œë¬¸ì„ ì‚¬ìš©í•˜ë©´ Edge ìºì‹œì˜ ì½˜í…ì¸ ë¥¼ ì œê³µí•˜ëŠ” ë™ì‹œì— í•¨ìˆ˜ì˜ ì‘ë‹µìœ¼ë¡œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìºì‹œë¥¼ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.Â ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ì— ìœ ìš©í•©ë‹ˆë‹¤.

### ì œí•œ

- ìºì‹œ ê°€ëŠ¥í•œ ìµœëŒ€ ì‘ë‹µ í¬ê¸° =Â **10MB**
- ìµœëŒ€ ìºì‹œ ì‹œê°„ =Â **31ì¼**

### ì°¸ê³ 

- [https://vercel.com/guides/how-can-i-improve-serverless-function-lambda-cold-start-performance-on-vercel](https://vercel.com/guides/how-can-i-improve-serverless-function-lambda-cold-start-performance-on-vercel)
